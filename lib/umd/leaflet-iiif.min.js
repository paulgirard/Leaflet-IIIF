!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i(require("leaflet")):"function"==typeof define&&define.amd?define(["leaflet"],i):"object"==typeof exports?exports["leaflet-iiif"]=i(require("leaflet")):t["leaflet-iiif"]=i(t.L)}(this,(function(t){return(()=>{"use strict";var i=[,(t,i,e)=>{e.r(i),e.d(i,{IIIF_EVENTS:()=>o});const o={CHANGE_FORMAT:"iiif:format",CHANGE_QUALITY:"iiif:quality",CHANGE_ROTATION:"iiif:rotation",CHANGE_MIRRORING:"iiif:mirroring"}},(t,i,e)=>{e.r(i),e.d(i,{IIIFLayer:()=>u});var o=e(3),s=e.n(o),a=e(4),r=e(1),n=e(5),l=e(6),h=e(7),c=function(t,i,e,o){return new(e||(e=Promise))((function(s,a){function r(t){try{l(o.next(t))}catch(t){a(t)}}function n(t){try{l(o.throw(t))}catch(t){a(t)}}function l(t){var i;t.done?s(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(r,n)}l((o=o.apply(t,i||[])).next())}))};class u extends o.TileLayer{constructor(t,i={}){super(t,i),this.map=null,this.server=a.SERVER_CAPABILITIES_DEFAULT,this.height=0,this.width=0,this.zoomLayers=[],this.setUrl((0,l.templateUrl)(t))}initialize(t,i){return this.initializePromise=new Promise(((e,o)=>c(this,void 0,void 0,(function*(){try{const o=yield fetch(t),r=yield o.json();this.height=r.height,this.width=r.width,this.server=(0,n.computeServerCapabilities)(r),this.options=s().Util.setOptions(this,Object.assign({},a.DEFAULT_OPTIONS,{tileSize:this.server.tileSize,tileFormat:this.server.formats[0],quality:this.server.qualities.includes("native")?"native":"default",minZoom:this.server.minZoom,maxZoom:this.server.maxZoom},i)),e()}catch(t){o(t)}})))),this}onAdd(t){return this.map=t,this.initializePromise.then((()=>{this.computeZoomLayers(),super.onAdd(t),this.options.fitBounds&&this.map.fitBounds(this.getBounds()),this.options.setMaxBounds&&this.map.setMaxBounds(this.getBounds())})),this.registerEvents(t),this}onRemove(t){return super.onRemove(t),this.options.setMaxBounds&&t.setMaxBounds(null),this.unRegisterEvents(t),this}getTileUrl(t){const i=t.z,e=t.x,o=t.y,a=this.zoomLayers.find((t=>t.zoom===i));if(!a)throw new Error(`Can't create tile for zoom ${i}`);const r=(0,h.projectSquare)(-1*this.options.rotation,{bottomLeft:{x:e,y:o},topRight:{x:e+1,y:o+1}}),n=this.options.tileSize.x/a.scale,l=this.options.tileSize.y/a.scale;let c=Math.min(r.bottomLeft.x*n,this.width);const u=Math.min(r.bottomLeft.y*l,this.height);let m=Math.min(c+n,this.width);const p=Math.min(u+l,this.height);if(!0===this.options.mirroring){const t=m-c;c=this.width-c-t,m=this.width-m+t}const f={format:this.options.tileFormat,quality:this.options.quality,mirroring:this.options.mirroring,region:[c,u,Math.abs(m-c),Math.abs(p-u)],rotation:(360-this.options.rotation)%360,size:[Math.abs(m-c),Math.abs(p-u)].map((t=>Math.ceil(t*a.scale)))};return s().Util.template(this._url,{format:f.format,quality:f.quality,mirroring:f.mirroring?"!":"",region:f.region.join(","),rotation:f.rotation,size:f.size.join(",")})}_isValidTile(t){let i=!1;const e=t.x,o=t.y,s=t.z,a=(0,h.projectSquare)(-1*this.options.rotation,{bottomLeft:{x:e,y:o},topRight:{x:e+1,y:o+1}});if(this.options.minZoom<=s&&s<=this.options.maxZoom){const t=this.zoomLayers.find((t=>t.zoom===s));0<=a.bottomLeft.x&&a.bottomLeft.x<t.tiles[0]&&0<=a.bottomLeft.y&&a.bottomLeft.y<t.tiles[1]&&(i=!0)}return i}getBounds(){let t=s().latLngBounds([0,1],[1,0]);const i=this.zoomLayers.find((t=>1===t.scale));if(null!==this.map&&i){const e=(0,h.projectSquare)(this.options.rotation,{bottomLeft:{x:0,y:i.height},topRight:{x:i.width,y:0}}),o=this.map.unproject(s().point(e.bottomLeft),0),a=this.map.unproject(s().point(e.topRight),0);t=s().latLngBounds(o,a)}return t}computeZoomLayers(){this.zoomLayers=[];let t=this.options.minZoom;for(;t<=this.options.maxZoom;){const i=Math.pow(2,t),e=Math.ceil(this.height*i),o=Math.ceil(this.width*i);this.zoomLayers.push({zoom:t,scale:i,height:e,width:o,tiles:[Math.ceil(o/this.options.tileSize.x),Math.ceil(e/this.options.tileSize.y)]}),t++}this.map.setMaxZoom(this.zoomLayers[this.zoomLayers.length-1].zoom),this.map.setMinZoom(this.zoomLayers[0].zoom)}registerEvents(t){this.on("tileload",this.onTileLoadStyle),t.on(r.IIIF_EVENTS.CHANGE_FORMAT,(t=>this.changeFormat(t.value))),t.on(r.IIIF_EVENTS.CHANGE_QUALITY,(t=>this.changeQuality(t.value))),t.on(r.IIIF_EVENTS.CHANGE_ROTATION,(t=>this.changeRotation(t.value))),t.on(r.IIIF_EVENTS.CHANGE_MIRRORING,(t=>this.changeMirroring(t.value)))}unRegisterEvents(t){this.off("tileload",this.onTileLoadStyle),t.off(r.IIIF_EVENTS.CHANGE_FORMAT,(t=>this.changeFormat(t.value))),t.off(r.IIIF_EVENTS.CHANGE_QUALITY,(t=>this.changeQuality(t.value))),t.off(r.IIIF_EVENTS.CHANGE_ROTATION,(t=>this.changeRotation(t.value))),t.off(r.IIIF_EVENTS.CHANGE_MIRRORING,(t=>this.changeMirroring(t.value)))}changeFormat(t){this.options.tileFormat=t,this.redraw()}changeQuality(t){this.options.quality=t,this.redraw()}changeRotation(t){this.options.rotation=t,this.options.setMaxBounds&&this.map.setMaxBounds(this.getBounds()),this.redraw()}changeMirroring(t){this.options.mirroring=t,this.redraw()}onTileLoadStyle(t){if(t.tile.naturalWidth!==this.options.tileSize.x||t.tile.naturalHeight!==this.options.tileSize.y){t.tile.style.width=`${t.tile.naturalWidth}px`,t.tile.style.height=`${t.tile.naturalHeight}px`;switch(this.options.rotation%360){case 90:t.tile.style.top=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.right=this.options.tileSize.y-t.tile.naturalWidth+"px";break;case 180:t.tile.style.top=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.left=this.options.tileSize.y-t.tile.naturalWidth+"px";break;case 270:t.tile.style.top="0",t.tile.style.bottom=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.left=this.options.tileSize.y-t.tile.naturalWidth+"px"}}}}},i=>{i.exports=t},(t,i,e)=>{e.r(i),e.d(i,{SERVER_CAPABILITIES_DEFAULT:()=>s,DEFAULT_OPTIONS:()=>a,DEFAULT_CONTROL_OPTIONS:()=>r});var o=e(3);const s={version:"3.0",formats:[],qualities:[],rotation:!1,mirroring:!1,tileSize:null,minZoom:0,maxZoom:0},a={tileSize:e.n(o)().point(256,256),tileFormat:"jpg",quality:"default",rotation:0,mirroring:!1,fitBounds:!0,setMaxBounds:!1,minZoom:0,maxZoom:0,zoomOffset:0},r={quality:{enabled:!0,title:"Quality",html:"<span />"},format:{enabled:!0,title:"Format",html:"<span />"},rotation:{enabled:!0,title:"Rotation",html:"<span />"},mirroring:{enabled:!0,title:"Mirroring",html:"<span />"}}},(t,i,e)=>{e.r(i),e.d(i,{computeServerCapabilities:()=>r,computeServerCapabilitiesForV1:()=>n});var o=e(3),s=e.n(o),a=e(4);function r(t){let i=`${t["@context"]}`;switch(t["@context"]instanceof Array&&(i=t["@context"][t["@context"].length-1]),i){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return n(t);case"http://iiif.io/api/image/2/context.json":return function(t){const i=Object.assign({},a.SERVER_CAPABILITIES_DEFAULT);i.version="2.0";switch(t.profile[0]){case"level2":i.qualities=["default","bitonial"],i.formats=["jpg","png"];break;case"level1":i.qualities=["default"],i.formats=["jpg","png"];break;default:i.qualities=["default"],i.formats=["jpg"]}t.profile[1]&&t.profile[1].formats&&(i.formats=t.profile[1].formats);t.profile[1]&&t.profile[1].qualities&&(i.qualities=t.profile[1].qualities);t.profile[1]&&t.profile[1].supports&&(t.profile[1].supports.includes("rotationBy90s")||t.profile[1].supports.includes("rotationArbitrary"))&&(i.rotation=!0);t.profile[1]&&t.profile[1].supports&&t.profile[1].supports.includes("mirroring")&&(i.mirroring=!0);if(t.tiles&&t.tiles.length>-1){const e=t.tiles[0];i.tileSize=s().point(e.width,e.height?e.height:e.width),i.minZoom=Math.log2(e.scaleFactors[e.scaleFactors.length-1])*(e.scaleFactors[e.scaleFactors.length-1]>1?-1:1),i.maxZoom=Math.log2(e.scaleFactors[0])*(e.scaleFactors[0]>1?-1:1)}return i}(t);case"http://iiif.io/api/image/3/context.json":default:return function(t){const i=Object.assign({},a.SERVER_CAPABILITIES_DEFAULT);i.version="3.0";switch(t.profile){case"level2":i.qualities=["default"],i.formats=["jpg","png"];break;default:i.qualities=["default"],i.formats=["jpg"]}t.extraFormats&&t.extraFormats instanceof Array&&(i.formats=i.formats.concat(t.extraFormats.filter((t=>!i.formats.includes(t)))));t.extraQualities&&t.extraQualities instanceof Array&&(i.qualities=i.qualities.concat(t.extraQualities.filter((t=>!i.qualities.includes(t)))));t.extraFeatures&&(t.extraFeatures.includes("rotationBy90s")||t.extraFeatures.includes("rotationArbitrary"))&&(i.rotation=!0);t.extraFeatures&&t.extraFeatures.includes("mirroring")&&(i.mirroring=!0);if(t.tiles&&t.tiles.length>-1){const e=t.tiles[0];i.tileSize=s().point(e.width,e.height?e.height:e.width),i.minZoom=Math.log2(e.scaleFactors[e.scaleFactors.length-1])*(e.scaleFactors[e.scaleFactors.length-1]>1?-1:1),i.maxZoom=Math.log2(e.scaleFactors[0])*(e.scaleFactors[0]>1?-1:1)}return i}(t)}}function n(t){const i=Object.assign({},a.SERVER_CAPABILITIES_DEFAULT);i.version="1.1";const e=`${t.profile}`.match(/^http:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#(.*)$/);switch(e&&2===e.length?e[1]:"level0"){case"level2":i.rotation=!0,i.formats=["jpg","png"],i.qualities=["native","color","grey","bitonial"];break;case"level1":i.rotation=!0,i.formats=["jpg"],i.qualities=["native"];break;default:i.rotation=!1,i.formats=["jpg"],i.qualities=["native"]}return t.formats&&(i.formats=t.formats),t.qualities&&(i.qualities=t.qualities),t.tile_width&&(i.tileSize=s().point(t.tile_width,t.tile_height?t.tile_height:t.tile_width)),t.scale_factors&&t.scale_factors.length>-1&&(i.minZoom=Math.log2(t.scale_factors[t.scale_factors.length-1])*(t.scale_factors[t.scale_factors.length-1]>1?-1:1),i.maxZoom=Math.log2(t.scale_factors[0])*(t.scale_factors[0]>1?-1:1)),i}},(t,i,e)=>{function o(t){return t.replace(/info.json$/,"{region}/{size}/{mirroring}{rotation}/{quality}.{format}")}e.r(i),e.d(i,{templateUrl:()=>o})},(t,i,e)=>{function o(t,i){const e=-1*t*Math.PI/180;return{x:Math.round(i.x*Math.cos(e)-i.y*Math.sin(e)),y:Math.round(i.y*Math.cos(e)+i.x*Math.sin(e))}}function s(t,i){const e=o(t,i.bottomLeft),s=o(t,i.topRight),a=Math.min(e.x,s.x),r=Math.max(e.x,s.x);return{bottomLeft:{x:a,y:Math.min(e.y,s.y)},topRight:{x:r,y:Math.max(e.y,s.y)}}}e.r(i),e.d(i,{projectPoint:()=>o,projectSquare:()=>s})},(t,i,e)=>{e.r(i),e.d(i,{IIIFControl:()=>l});var o=e(3),s=e.n(o),a=e(1),r=e(4);const n="leaflet-control-iiif";class l extends o.Control{constructor(t,i={}){super(Object.assign({},r.DEFAULT_CONTROL_OPTIONS,i)),this.layer=t,this._container=s().DomUtil.create("div",`${n} leaflet-bar`)}onAdd(t){const i=this.getContainer();return this.layer.initializePromise.then((()=>{if(!0===this.options.quality.enabled){const e=this.options.quality.values?this.options.quality.values:this.layer.server.qualities;this.createActions(i,this.options.quality.title,`${n}-quality`,this.options.quality.html,e.map((i=>({title:i,className:`${n}-quality-${i}`,innerHTML:i,fn:()=>{t.fire(a.IIIF_EVENTS.CHANGE_QUALITY,{value:i})}}))))}if(!0===this.options.format.enabled){const e=this.options.format.values?this.options.format.values:this.layer.server.formats;this.createActions(i,this.options.format.title,`${n}-format`,this.options.format.html,e.map((i=>({title:i,className:`${n}-format-${i}`,innerHTML:i,fn:()=>{t.fire(a.IIIF_EVENTS.CHANGE_FORMAT,{value:i})}}))))}if(!0===this.options.rotation.enabled&&!0===this.layer.server.rotation){const e=this.options.rotation.values?this.options.rotation.values:["0","90","180","270"];this.createActions(i,this.options.rotation.title,`${n}-rotation`,this.options.rotation.html,e.map((i=>({title:i,className:`${n}-rotation-${i}`,innerHTML:i,fn:()=>{t.fire(a.IIIF_EVENTS.CHANGE_ROTATION,{value:Number.parseInt(i)})}}))))}!0===this.options.mirroring.enabled&&!0===this.layer.server.mirroring&&this.createButton(i,this.options.mirroring.title,`${n}-mirroring`,this.options.mirroring.html,(()=>{t.fire(a.IIIF_EVENTS.CHANGE_MIRRORING,{value:!this.layer.options.mirroring})}))})),i}createActions(t,i,e,o,a){const r=s().DomUtil.create("div",e);this.createButton(r,i,e,o,(()=>{t.dataset.opened===e?t.dataset.opened="":t.dataset.opened=e}));const n=s().DomUtil.create("ul",e);a.forEach((i=>{const e=s().DomUtil.create("li","",n);this.createButton(e,i.title,i.className,i.innerHTML,(()=>{i.fn(),t.dataset.opened=""})),n.appendChild(e)})),r.appendChild(n),t.appendChild(r)}createButton(t,i,e,o,a){const r=s().DomUtil.create("a",e,t);return r.title=i,r.innerHTML=o,s().DomEvent.on(r,"mousedown dblclick",s().DomEvent.stopPropagation).on(r,"click",a,this),r}}}],e={};function o(t){var s=e[t];if(void 0!==s)return s.exports;var a=e[t]={exports:{}};return i[t](a,a.exports,o),a.exports}o.n=t=>{var i=t&&t.__esModule?()=>t.default:()=>t;return o.d(i,{a:i}),i},o.d=(t,i)=>{for(var e in i)o.o(i,e)&&!o.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:i[e]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};return(()=>{o.r(s),o.d(s,{IIIFLayer:()=>i.IIIFLayer,IIIFControl:()=>e.IIIFControl});var t=o(1),i=o(2),e=o(8);window.L.Iiif={Event:t.IIIF_EVENTS},window.L.tileLayer.iiif=function(t,e){return new i.IIIFLayer(t,e)},window.L.control.iiif=function(t,i){return new e.IIIFControl(t,i)}})(),s})()}));
//# sourceMappingURL=leaflet-iiif.min.js.map