!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i(require("leaflet")):"function"==typeof define&&define.amd?define(["leaflet"],i):"object"==typeof exports?exports["leaflet-iiif"]=i(require("leaflet")):t["leaflet-iiif"]=i(t.L)}(this,(function(t){return(()=>{"use strict";var i={389:i=>{i.exports=t}},e={};function o(t){var s=e[t];if(void 0!==s)return s.exports;var a=e[t]={exports:{}};return i[t](a,a.exports,o),a.exports}o.n=t=>{var i=t&&t.__esModule?()=>t.default:()=>t;return o.d(i,{a:i}),i},o.d=(t,i)=>{for(var e in i)o.o(i,e)&&!o.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:i[e]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};return(()=>{const t={CHANGE_FORMAT:"iiif:format",CHANGE_QUALITY:"iiif:quality",CHANGE_ROTATION:"iiif:rotation",CHANGE_MIRRORING:"iiif:mirroring"};var i=o(389),e=o.n(i);const s={version:"3.0",formats:[],qualities:[],rotation:!1,mirroring:!1,tileSize:null,minZoom:0,maxZoom:0},a={tileSize:e().point(256,256),tileFormat:"jpg",quality:"default",rotation:0,mirroring:!1,fitBounds:!0,setMaxBounds:!1,minZoom:0,maxZoom:0,zoomOffset:0},n={quality:{enabled:!0,title:"Quality",html:"<span />"},format:{enabled:!0,title:"Format",html:"<span />"},rotation:{enabled:!0,title:"Rotation",html:"<span />"},mirroring:{enabled:!0,title:"Mirroring",html:"<span />"}};function r(t,i){const e=-1*t*Math.PI/180;return{x:Math.round(i.x*Math.cos(e)-i.y*Math.sin(e)),y:Math.round(i.y*Math.cos(e)+i.x*Math.sin(e))}}function l(t,i){const e=r(t,i.bottomLeft),o=r(t,i.topRight),s=Math.min(e.x,o.x),a=Math.max(e.x,o.x);return{bottomLeft:{x:s,y:Math.min(e.y,o.y)},topRight:{x:a,y:Math.max(e.y,o.y)}}}class h extends i.TileLayer{constructor(t,i={}){super(t,i),this.map=null,this.server=s,this.height=0,this.width=0,this.zoomLayers=[],this.setUrl(function(t){return t.replace(/info.json$/,"{region}/{size}/{mirroring}{rotation}/{quality}.{format}")}(t))}initialize(t,i){return this.initializePromise=new Promise(((o,n)=>{return r=this,l=void 0,c=function*(){try{const n=yield fetch(t),r=yield n.json();this.height=r.height,this.width=r.width,this.server=function(t){let i=`${t["@context"]}`;switch(t["@context"]instanceof Array&&(i=t["@context"][t["@context"].length-1]),i){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return function(t){const i=Object.assign({},s);i.version="1.1";const o=`${t.profile}`.match(/^http:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#(.*)$/);switch(o&&2===o.length?o[1]:"level0"){case"level2":i.rotation=!0,i.formats=["jpg","png"],i.qualities=["native","color","grey","bitonial"];break;case"level1":i.rotation=!0,i.formats=["jpg"],i.qualities=["native"];break;default:i.rotation=!1,i.formats=["jpg"],i.qualities=["native"]}return t.formats&&(i.formats=t.formats),t.qualities&&(i.qualities=t.qualities),t.tile_width&&(i.tileSize=e().point(t.tile_width,t.tile_height?t.tile_height:t.tile_width)),t.scale_factors&&t.scale_factors.length>-1&&(i.minZoom=Math.log2(t.scale_factors[t.scale_factors.length-1])*(t.scale_factors[t.scale_factors.length-1]>1?-1:1),i.maxZoom=Math.log2(t.scale_factors[0])*(t.scale_factors[0]>1?-1:1)),i}(t);case"http://iiif.io/api/image/2/context.json":return function(t){const i=Object.assign({},s);switch(i.version="2.0",t.profile[0]){case"level2":i.qualities=["default","bitonial"],i.formats=["jpg","png"];break;case"level1":i.qualities=["default"],i.formats=["jpg","png"];break;default:i.qualities=["default"],i.formats=["jpg"]}if(t.profile[1]&&t.profile[1].formats&&(i.formats=t.profile[1].formats),t.profile[1]&&t.profile[1].qualities&&(i.qualities=t.profile[1].qualities),t.profile[1]&&t.profile[1].supports&&(t.profile[1].supports.includes("rotationBy90s")||t.profile[1].supports.includes("rotationArbitrary"))&&(i.rotation=!0),t.profile[1]&&t.profile[1].supports&&t.profile[1].supports.includes("mirroring")&&(i.mirroring=!0),t.tiles&&t.tiles.length>-1){const o=t.tiles[0];i.tileSize=e().point(o.width,o.height?o.height:o.width),i.minZoom=Math.log2(o.scaleFactors[o.scaleFactors.length-1])*(o.scaleFactors[o.scaleFactors.length-1]>1?-1:1),i.maxZoom=Math.log2(o.scaleFactors[0])*(o.scaleFactors[0]>1?-1:1)}return i}(t);case"http://iiif.io/api/image/3/context.json":default:return function(t){const i=Object.assign({},s);switch(i.version="3.0",t.profile){case"level2":i.qualities=["default"],i.formats=["jpg","png"];break;default:i.qualities=["default"],i.formats=["jpg"]}if(t.extraFormats&&t.extraFormats instanceof Array&&(i.formats=i.formats.concat(t.extraFormats.filter((t=>!i.formats.includes(t))))),t.extraQualities&&t.extraQualities instanceof Array&&(i.qualities=i.qualities.concat(t.extraQualities.filter((t=>!i.qualities.includes(t))))),t.extraFeatures&&(t.extraFeatures.includes("rotationBy90s")||t.extraFeatures.includes("rotationArbitrary"))&&(i.rotation=!0),t.extraFeatures&&t.extraFeatures.includes("mirroring")&&(i.mirroring=!0),t.tiles&&t.tiles.length>-1){const o=t.tiles[0];i.tileSize=e().point(o.width,o.height?o.height:o.width),i.minZoom=Math.log2(o.scaleFactors[o.scaleFactors.length-1])*(o.scaleFactors[o.scaleFactors.length-1]>1?-1:1),i.maxZoom=Math.log2(o.scaleFactors[0])*(o.scaleFactors[0]>1?-1:1)}return i}(t)}}(r),this.options=e().Util.setOptions(this,Object.assign({},a,{tileSize:this.server.tileSize,tileFormat:this.server.formats[0],quality:this.server.qualities.includes("native")?"native":"default",minZoom:this.server.minZoom,maxZoom:this.server.maxZoom},i)),o()}catch(t){n(t)}},new((h=void 0)||(h=Promise))((function(t,i){function e(t){try{s(c.next(t))}catch(t){i(t)}}function o(t){try{s(c.throw(t))}catch(t){i(t)}}function s(i){var s;i.done?t(i.value):(s=i.value,s instanceof h?s:new h((function(t){t(s)}))).then(e,o)}s((c=c.apply(r,l||[])).next())}));var r,l,h,c})),this}onAdd(t){return this.map=t,this.initializePromise.then((()=>{this.computeZoomLayers(),super.onAdd(t),this.options.fitBounds&&this.map.fitBounds(this.getBounds()),this.options.setMaxBounds&&this.map.setMaxBounds(this.getBounds())})),this.registerEvents(t),this}onRemove(t){return super.onRemove(t),this.options.setMaxBounds&&t.setMaxBounds(null),this.unRegisterEvents(t),this}getTileUrl(t){const i=t.z,o=t.x,s=t.y,a=this.zoomLayers.find((t=>t.zoom===i));if(!a)throw new Error(`Can't create tile for zoom ${i}`);const n=l(-1*this.options.rotation,{bottomLeft:{x:o,y:s},topRight:{x:o+1,y:s+1}}),r=this.options.tileSize.x/a.scale,h=this.options.tileSize.y/a.scale;let c=Math.min(n.bottomLeft.x*r,this.width);const u=Math.min(n.bottomLeft.y*h,this.height);let m=Math.min(c+r,this.width);const p=Math.min(u+h,this.height);if(!0===this.options.mirroring){const t=m-c;c=this.width-c-t,m=this.width-m+t}const f={format:this.options.tileFormat,quality:this.options.quality,mirroring:this.options.mirroring,region:[c,u,Math.abs(m-c),Math.abs(p-u)],rotation:(360-this.options.rotation)%360,size:[Math.abs(m-c),Math.abs(p-u)].map((t=>Math.ceil(t*a.scale)))};return e().Util.template(this._url,{format:f.format,quality:f.quality,mirroring:f.mirroring?"!":"",region:f.region.join(","),rotation:f.rotation,size:f.size.join(",")})}_isValidTile(t){let i=!1;const e=t.x,o=t.y,s=t.z,a=l(-1*this.options.rotation,{bottomLeft:{x:e,y:o},topRight:{x:e+1,y:o+1}});if(this.options.minZoom<=s&&s<=this.options.maxZoom){const t=this.zoomLayers.find((t=>t.zoom===s));0<=a.bottomLeft.x&&a.bottomLeft.x<t.tiles[0]&&0<=a.bottomLeft.y&&a.bottomLeft.y<t.tiles[1]&&(i=!0)}return i}getBounds(){let t=e().latLngBounds([0,1],[1,0]);const i=this.zoomLayers.find((t=>1===t.scale));if(null!==this.map&&i){const o=l(this.options.rotation,{bottomLeft:{x:0,y:i.height},topRight:{x:i.width,y:0}}),s=this.map.unproject(e().point(o.bottomLeft),0),a=this.map.unproject(e().point(o.topRight),0);t=e().latLngBounds(s,a)}return t}computeZoomLayers(){this.zoomLayers=[];let t=this.options.minZoom;for(;t<=this.options.maxZoom;){const i=Math.pow(2,t),e=Math.ceil(this.height*i),o=Math.ceil(this.width*i);this.zoomLayers.push({zoom:t,scale:i,height:e,width:o,tiles:[Math.ceil(o/this.options.tileSize.x),Math.ceil(e/this.options.tileSize.y)]}),t++}this.map.setMaxZoom(this.zoomLayers[this.zoomLayers.length-1].zoom),this.map.setMinZoom(this.zoomLayers[0].zoom)}registerEvents(i){this.on("tileload",this.onTileLoadStyle),i.on(t.CHANGE_FORMAT,(t=>this.changeFormat(t.value))),i.on(t.CHANGE_QUALITY,(t=>this.changeQuality(t.value))),i.on(t.CHANGE_ROTATION,(t=>this.changeRotation(t.value))),i.on(t.CHANGE_MIRRORING,(t=>this.changeMirroring(t.value)))}unRegisterEvents(i){this.off("tileload",this.onTileLoadStyle),i.off(t.CHANGE_FORMAT,(t=>this.changeFormat(t.value))),i.off(t.CHANGE_QUALITY,(t=>this.changeQuality(t.value))),i.off(t.CHANGE_ROTATION,(t=>this.changeRotation(t.value))),i.off(t.CHANGE_MIRRORING,(t=>this.changeMirroring(t.value)))}changeFormat(t){this.options.tileFormat=t,this.redraw()}changeQuality(t){this.options.quality=t,this.redraw()}changeRotation(t){this.options.rotation=t,this.options.setMaxBounds&&this.map.setMaxBounds(this.getBounds()),this.redraw()}changeMirroring(t){this.options.mirroring=t,this.redraw()}onTileLoadStyle(t){if(t.tile.naturalWidth!==this.options.tileSize.x||t.tile.naturalHeight!==this.options.tileSize.y)switch(t.tile.style.width=`${t.tile.naturalWidth}px`,t.tile.style.height=`${t.tile.naturalHeight}px`,this.options.rotation%360){case 90:t.tile.style.top=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.right=this.options.tileSize.y-t.tile.naturalWidth+"px";break;case 180:t.tile.style.top=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.left=this.options.tileSize.y-t.tile.naturalWidth+"px";break;case 270:t.tile.style.top="0",t.tile.style.bottom=this.options.tileSize.x-t.tile.naturalHeight+"px",t.tile.style.left=this.options.tileSize.y-t.tile.naturalWidth+"px"}}}const c="leaflet-control-iiif";class u extends i.Control{constructor(t,i={}){super(Object.assign({},n,i)),this.layer=t,this._container=e().DomUtil.create("div",`${c} leaflet-bar`)}onAdd(i){const e=this.getContainer();return this.layer.initializePromise.then((()=>{if(!0===this.options.quality.enabled){const o=this.options.quality.values?this.options.quality.values:this.layer.server.qualities;this.createActions(e,this.options.quality.title,`${c}-quality`,this.options.quality.html,o.map((e=>({title:e,className:`${c}-quality-${e}`,innerHTML:e,fn:()=>{i.fire(t.CHANGE_QUALITY,{value:e})}}))))}if(!0===this.options.format.enabled){const o=this.options.format.values?this.options.format.values:this.layer.server.formats;this.createActions(e,this.options.format.title,`${c}-format`,this.options.format.html,o.map((e=>({title:e,className:`${c}-format-${e}`,innerHTML:e,fn:()=>{i.fire(t.CHANGE_FORMAT,{value:e})}}))))}if(!0===this.options.rotation.enabled&&!0===this.layer.server.rotation){const o=this.options.rotation.values?this.options.rotation.values:["0","90","180","270"];this.createActions(e,this.options.rotation.title,`${c}-rotation`,this.options.rotation.html,o.map((e=>({title:e,className:`${c}-rotation-${e}`,innerHTML:e,fn:()=>{i.fire(t.CHANGE_ROTATION,{value:Number.parseInt(e)})}}))))}!0===this.options.mirroring.enabled&&!0===this.layer.server.mirroring&&this.createButton(e,this.options.mirroring.title,`${c}-mirroring`,this.options.mirroring.html,(()=>{i.fire(t.CHANGE_MIRRORING,{value:!this.layer.options.mirroring})}))})),e}createActions(t,i,o,s,a){const n=e().DomUtil.create("div",o);this.createButton(n,i,o,s,(()=>{t.dataset.opened===o?t.dataset.opened="":t.dataset.opened=o}));const r=e().DomUtil.create("ul",o);a.forEach((i=>{const o=e().DomUtil.create("li","",r);this.createButton(o,i.title,i.className,i.innerHTML,(()=>{i.fn(),t.dataset.opened=""})),r.appendChild(o)})),n.appendChild(r),t.appendChild(n)}createButton(t,i,o,s,a){const n=e().DomUtil.create("a",o,t);return n.title=i,n.innerHTML=s,e().DomEvent.on(n,"mousedown dblclick",e().DomEvent.stopPropagation).on(n,"click",a,this),n}}window.L.Iiif={Event:t},window.L.tileLayer.iiif=function(t,i){return new h(t,i)},window.L.control.iiif=function(t,i){return new u(t,i)}})(),o.r(s),s})()}));